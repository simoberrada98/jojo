# ALT Table: Design, Migration, and Verification

## Purpose

- `public.alt` stores product records present in `data/products.csv` but missing from `public.products`.
- Mirrors the `products` schema and adds CSV-specific columns (`gtin`, `category_tags`).
- Used as a staging area to reconcile differences without polluting the primary `products` table.

## Schema Overview

- Primary key: `id BIGINT GENERATED BY DEFAULT AS IDENTITY`.
- Unique identifiers: `slug UNIQUE`, `sku UNIQUE`, `gtin` indexed.
- Core fields: `sku`, `name`, `slug`, `description`, `short_description`, `category`, `brand`, `tags` (text[]), pricing (`base_price`, `compare_at_price`, `cost_price`).
- Mining specs: `hash_rate`, `power_consumption`, `algorithm`, `efficiency`.
- Physical: `weight`, `dimensions_length|width|height`.
- Media: `featured_image_url`, `images` (text[]), `video_url`, `model_3d_url`.
- Inventory: `track_inventory`, `stock_quantity`, `low_stock_threshold`, `allow_backorder`.
- SEO: `meta_title`, `meta_description`, `meta_keywords` (text[]).
- Status: `is_featured`, `is_active`, `is_archived`, `published_at`.
- Auditing: `created_at TIMESTAMPTZ DEFAULT NOW()`, `updated_at TIMESTAMPTZ DEFAULT NOW()` with update trigger.
- CSV extras: `gtin TEXT`, `category_tags TEXT[]`.

## Migration

1. Migration file: `supabase/migrations/20251108_create_alt_table.sql` defines table, indexes, and `updated_at` trigger.
2. Apply locally (Supabase CLI):
   - Ensure Docker is running.
   - `supabase start`
   - `supabase migration up`
3. Apply in hosted Supabase:
   - Copy SQL contents into SQL editor and run.
   - Confirm table and indexes under Database → public → alt.

## Loading Data (Missing Only)

- Script: `scripts/load-alt-from-csv.ts`
- Reads `data/products.csv`, strips comment lines, parses robustly, sanitizes fields, and inserts only rows where `slug` does not exist in `products` or `alt`.
- Requires environment:
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `SUPABASE_SERVICE_ROLE_KEY`
- Run: `node scripts/load-alt-from-csv.ts`

## Verification

- Script: `scripts/verify-alt.ts`
- Performs:
  - Count comparison: CSV total, products total, expected missing, alt total.
  - Integrity checks: duplicates on `slug`/`sku`, required fields present.
  - CRUD tests: insert, read, update, delete on `alt`.
  - Relationship check: ensures `alt.slug` does not overlap `products.slug`.
- Run: `node scripts/verify-alt.ts`

## Notes

- `alt` is intentionally separate and not referenced by `product_variants` to avoid breaking relations. Once reconciled, records can be promoted into `products` via controlled migration/ETL.
- Arrays accept both JSON-like `["a"]` and Postgres-like `{a}` on input via loader’s sanitization.
- `gtin` normalization retains digits and accepts common lengths (8/12/13/14).
